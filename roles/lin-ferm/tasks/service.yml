---
- name: setup ferm service
  template:
    src: etc/ferm.service
    dest: /etc/systemd/system/ferm.service
  vars:
    ferm_config: "{{ ferm_dir }}/config.ferm"
    force_cleanup: '/usr/bin/env FERM_FORCE_HOOKS=1'
    lock_xtables: "/usr/bin/flock {{ no_fork }}/run/xtables.lock"
    no_fork: "{{ modern_flock |ternary('--no-fork ', '') }}"
    modern_flock: "{{ ansible_lsb.release is version('16.04', '>') }}"
  register: ferm_service_result
  notify: reload ferm service

- name: reload ferm service config in systemd
  command: systemctl daemon-reload  # noqa 303
  when: ferm_service_result is changed

- name: disable ufw (please ignore possible failure)
  ufw:
    state: disabled
  no_log: "{{ hide_secrets |bool }}"
  ignore_errors: true

- name: activate ferm
  systemd:
    name: ferm
    state: started
    enabled: true
...
