---
- name: add docker signing key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg

- name: add docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
    filename: docker-ce
  register: add_docker_repo_result
  until: add_docker_repo_result is successful

- block:
    - name: install docker and friends
      apt:
        name:
          - docker-ce
          - jq  # jq helps to parse docker output
          - bash-completion
        state: "{{ docker_upgrade |bool |ternary('latest', 'present') }}"
        autoremove: true
        install_recommends: false
  rescue:
    - name: install docker and friends, update apt cache
      apt:
        name:
          - docker-ce
          - jq
          - bash-completion
        state: "{{ docker_upgrade |bool |ternary('latest', 'present') }}"
        autoremove: true
        install_recommends: false
        update_cache: true

- name: bash completion script for docker
  file:
    src: /usr/share/bash-completion/completions/docker
    dest: /etc/bash_completion.d/docker
    state: link

- name: create new docker daemon settings
  copy:
    content: "{}"
    dest: /etc/docker/daemon.json
    force: false
    owner: root
    mode: 0644
  when: docker_daemon_settings |default({}) |length
  notify: restart docker daemon

- name: set custom docker daemon settings
  json_patch:
    src: /etc/docker/daemon.json
    operations:
      - op: add
        path: "{{ item.0 }}"
        value: "{{ item.1 }}"
    pretty: true
  loop: "{{ docker_daemon_settings |default({}) |dictsort }}"
  notify: restart docker daemon
  ## ansible lint raises error because json_patch module belongs with custom collection
  tags: skip_ansible_lint

- name: enable docker service
  systemd:
    name: docker
    state: started
    enabled: true
...
